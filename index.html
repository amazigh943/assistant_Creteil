<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant ADN - Rectorat de Cr√©teil</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Marianne:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        const originalWarn = console.warn;
        console.warn = (...args) => {
            if (args[0]?.includes?.('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'fr-blue': '#000091',
                        'fr-red': '#e1000f',
                        'fr-light': '#f6f6f6',
                        'fr-dark': '#1e1e1e',
                        'fr-dark-bg': '#121212',
                    },
                    fontFamily: {
                        'marianne': ['Marianne', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        * { scrollbar-width: thin; }
        .light * { scrollbar-color: #000091 #e5e5e5; }
        .dark * { scrollbar-color: #6366f1 #1e1e1e; }
        *::-webkit-scrollbar { width: 6px; }
        *::-webkit-scrollbar-thumb { border-radius: 20px; }
        .light *::-webkit-scrollbar-thumb { background-color: #000091; }
        .dark *::-webkit-scrollbar-thumb { background-color: #6366f1; }
        
        .typing-dot { animation: bounce 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }
        
        .message-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item:hover { transform: translateX(4px); }
    </style>
</head>
<body class="font-marianne">
    <div id="root"></div>
    
    <script type="text/babel">
        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://zoxmtwpwhleeytmevlyv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpveG10d3B3aGxlZXl0bWV2bHl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NjQxNTcsImV4cCI6MjA4MDI0MDE1N30.FwjafAHukrcFPJO4hi6GRXHlRcHPTkcvGG--KfSidVE';
        const RAG_API_URL = 'http://localhost:5679/webhook/Rag';
        const ADMIN_EMAILS = ['admin@ac-creteil.fr', 'thadjazi@ac-creteil.fr'];
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ============================================
        // THEME CONTEXT
        // ============================================
        const ThemeContext = React.createContext();
        
        const ThemeProvider = ({ children }) => {
            const [isDark, setIsDark] = React.useState(() => {
                const saved = localStorage.getItem('theme');
                return saved ? saved === 'dark' : window.matchMedia('(prefers-color-scheme: dark)').matches;
            });
            
            React.useEffect(() => {
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                document.documentElement.classList.toggle('dark', isDark);
            }, [isDark]);
            
            return (
                <ThemeContext.Provider value={{ isDark, toggleTheme: () => setIsDark(!isDark) }}>
                    <div className={isDark ? 'dark' : 'light'}>{children}</div>
                </ThemeContext.Provider>
            );
        };
        
        const useTheme = () => React.useContext(ThemeContext);
        
        // ============================================
        // IC√îNES
        // ============================================
        const Icons = {
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Chat: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Logout: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Bot: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>,
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            File: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Chart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
        };
        
        // Theme Toggle Button
        const ThemeToggle = () => {
            const { isDark, toggleTheme } = useTheme();
            return (
                <button onClick={toggleTheme} className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10 transition text-gray-600 dark:text-gray-300" title={isDark ? 'Mode jour' : 'Mode nuit'}>
                    {isDark ? <Icons.Sun /> : <Icons.Moon />}
                </button>
            );
        };
        
        // Typing Indicator
        const TypingIndicator = () => (
            <div className="flex items-center gap-2 p-4 max-w-[80%]">
                <div className="w-8 h-8 rounded-full bg-fr-blue dark:bg-indigo-600 flex items-center justify-center text-white"><Icons.Bot /></div>
                <div className="bg-gray-100 dark:bg-white/10 rounded-2xl rounded-tl-none px-4 py-3">
                    <div className="flex gap-1">
                        <div className="w-2 h-2 bg-fr-blue/60 dark:bg-white/60 rounded-full typing-dot"></div>
                        <div className="w-2 h-2 bg-fr-blue/60 dark:bg-white/60 rounded-full typing-dot"></div>
                        <div className="w-2 h-2 bg-fr-blue/60 dark:bg-white/60 rounded-full typing-dot"></div>
                    </div>
                </div>
            </div>
        );
        
        // ============================================
        // LOGIN PAGE
        // ============================================
        const LoginPage = ({ onLogin, onSwitchToRegister }) => {
            const { isDark } = useTheme();
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState('');
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    onLogin(data.user);
                } catch (err) {
                    setError(err.message === 'Invalid login credentials' ? 'Email ou mot de passe incorrect' : err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="min-h-screen bg-white dark:bg-fr-dark-bg flex items-center justify-center p-4">
                    <div className="w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="flex items-center justify-center gap-2 mb-4">
                                <div className="text-5xl">üá´üá∑</div>
                            </div>
                            <h1 className="text-2xl font-bold text-fr-blue dark:text-white mb-1">Assistant ADN</h1>
                            <p className="text-gray-500 dark:text-gray-400">Acad√©mie de Cr√©teil</p>
                        </div>
                        
                        <div className="bg-white dark:bg-fr-dark border border-gray-200 dark:border-gray-700 rounded-lg p-8 shadow-sm">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-semibold text-gray-900 dark:text-white">Connexion</h2>
                                <ThemeToggle />
                            </div>
                            
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Adresse email</label>
                                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fr-dark-bg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-fr-blue dark:focus:ring-indigo-500 transition" placeholder="prenom.nom@ac-creteil.fr" required />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mot de passe</label>
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fr-dark-bg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-fr-blue dark:focus:ring-indigo-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                                </div>
                                {error && <div className="p-3 rounded-lg bg-fr-red/10 border border-fr-red/30 text-fr-red text-sm">{error}</div>}
                                <button type="submit" disabled={loading} className="w-full py-3 rounded-lg bg-fr-blue dark:bg-indigo-600 text-white font-semibold hover:bg-fr-blue/90 dark:hover:bg-indigo-500 transition disabled:opacity-50">{loading ? 'Connexion...' : 'Se connecter'}</button>
                            </form>
                            
                            <div className="mt-6 text-center">
                                <button onClick={onSwitchToRegister} className="text-gray-500 dark:text-gray-400 hover:text-fr-blue dark:hover:text-white transition text-sm">Pas encore de compte ? <span className="text-fr-blue dark:text-indigo-400 font-medium">S'inscrire</span></button>
                            </div>
                        </div>
                        
                        <p className="text-center text-xs text-gray-400 dark:text-gray-500 mt-6">Minist√®re de l'√âducation nationale</p>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // REGISTER PAGE
        // ============================================
        const RegisterPage = ({ onSwitchToLogin }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [confirmPassword, setConfirmPassword] = React.useState('');
            const [nom, setNom] = React.useState('');
            const [etablissement, setEtablissement] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState('');
            const [success, setSuccess] = React.useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                if (password !== confirmPassword) { setError('Les mots de passe ne correspondent pas'); setLoading(false); return; }
                if (password.length < 6) { setError('Le mot de passe doit contenir au moins 6 caract√®res'); setLoading(false); return; }
                try {
                    const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { nom, etablissement } } });
                    if (error) throw error;
                    if (data.user) await supabase.from('profiles').update({ nom, etablissement }).eq('id', data.user.id);
                    setSuccess(true);
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };
            
            if (success) {
                return (
                    <div className="min-h-screen bg-white dark:bg-fr-dark-bg flex items-center justify-center p-4">
                        <div className="bg-white dark:bg-fr-dark border border-gray-200 dark:border-gray-700 rounded-lg p-8 max-w-md w-full text-center shadow-sm">
                            <div className="text-5xl mb-4">‚úÖ</div>
                            <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-2">Inscription r√©ussie !</h2>
                            <p className="text-gray-500 dark:text-gray-400 mb-6">Vous pouvez maintenant vous connecter.</p>
                            <button onClick={onSwitchToLogin} className="px-6 py-3 rounded-lg bg-fr-blue dark:bg-indigo-600 text-white font-semibold hover:bg-fr-blue/90 dark:hover:bg-indigo-500 transition">Se connecter</button>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen bg-white dark:bg-fr-dark-bg flex items-center justify-center p-4">
                    <div className="w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-2xl font-bold text-fr-blue dark:text-white mb-1">Assistant ADN</h1>
                            <p className="text-gray-500 dark:text-gray-400">Cr√©er un compte</p>
                        </div>
                        
                        <div className="bg-white dark:bg-fr-dark border border-gray-200 dark:border-gray-700 rounded-lg p-8 shadow-sm">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-semibold text-gray-900 dark:text-white">Inscription</h2>
                                <ThemeToggle />
                            </div>
                            
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nom complet</label><input type="text" value={nom} onChange={(e) => setNom(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fr-dark-bg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-fr-blue dark:focus:ring-indigo-500 transition" placeholder="Jean Dupont" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">√âtablissement</label><input type="text" value={etablissement} onChange={(e) => setEtablissement(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fr-dark-bg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-fr-blue dark:focus:ring-indigo-500 transition" placeholder="Lyc√©e Victor Hugo" /></div>
                                <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Adresse email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fr-dark-bg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-fr-blue dark:focus:ring-indigo-500 transition" placeholder="prenom.nom@ac-creteil.fr" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mot de passe</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fr-dark-bg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-fr-blue dark:focus:ring-indigo-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirmer</label><input type="password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fr-dark-bg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-fr-blue dark:focus:ring-indigo-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required /></div>
                                {error && <div className="p-3 rounded-lg bg-fr-red/10 border border-fr-red/30 text-fr-red text-sm">{error}</div>}
                                <button type="submit" disabled={loading} className="w-full py-3 rounded-lg bg-fr-blue dark:bg-indigo-600 text-white font-semibold hover:bg-fr-blue/90 dark:hover:bg-indigo-500 transition disabled:opacity-50">{loading ? 'Inscription...' : "S'inscrire"}</button>
                            </form>
                            
                            <div className="mt-6 text-center"><button onClick={onSwitchToLogin} className="text-gray-500 dark:text-gray-400 hover:text-fr-blue dark:hover:text-white transition text-sm">D√©j√† un compte ? <span className="text-fr-blue dark:text-indigo-400 font-medium">Se connecter</span></button></div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // PROFILE PAGE
        // ============================================
        const ProfilePage = ({ user, profile, onBack, onUpdateProfile }) => {
            const [nom, setNom] = React.useState(profile?.nom || '');
            const [etablissement, setEtablissement] = React.useState(profile?.etablissement || '');
            const [newPassword, setNewPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [message, setMessage] = React.useState({ type: '', text: '' });
            
            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await supabase.from('profiles').update({ nom, etablissement }).eq('id', user.id);
                    onUpdateProfile({ nom, etablissement });
                    setMessage({ type: 'success', text: 'Profil mis √† jour !' });
                } catch (err) { setMessage({ type: 'error', text: err.message }); }
                finally { setLoading(false); }
            };
            
            const handleChangePassword = async (e) => {
                e.preventDefault();
                if (newPassword.length < 6) { setMessage({ type: 'error', text: 'Min 6 caract√®res' }); return; }
                setLoading(true);
                try {
                    await supabase.auth.updateUser({ password: newPassword });
                    setMessage({ type: 'success', text: 'Mot de passe modifi√© !' });
                    setNewPassword('');
                } catch (err) { setMessage({ type: 'error', text: err.message }); }
                finally { setLoading(false); }
            };
            
            return (
                <div className="min-h-screen bg-fr-light dark:bg-fr-dark-bg p-4 md:p-8">
                    <div className="max-w-2xl mx-auto">
                        <button onClick={onBack} className="flex items-center gap-2 text-gray-500 dark:text-gray-400 hover:text-fr-blue dark:hover:text-white mb-6 transition"><Icons.ArrowLeft /> Retour</button>
                        <div className="bg-white dark:bg-fr-dark border border-gray-200 dark:border-gray-700 rounded-lg p-8 shadow-sm">
                            <div className="flex items-center gap-4 mb-8">
                                <div className="w-16 h-16 rounded-full bg-fr-blue dark:bg-indigo-600 flex items-center justify-center text-white text-2xl font-bold">{(nom || user?.email)?.[0]?.toUpperCase()}</div>
                                <div><h1 className="text-2xl font-bold text-gray-900 dark:text-white">{nom || 'Mon profil'}</h1><p className="text-gray-500 dark:text-gray-400">{user.email}</p></div>
                            </div>
                            <form onSubmit={handleUpdateProfile} className="space-y-4 mb-8">
                                <h3 className="text-lg font-semibold text-gray-900 dark:text-white">Informations</h3>
                                <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nom</label><input type="text" value={nom} onChange={(e) => setNom(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fr-dark-bg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-fr-blue dark:focus:ring-indigo-500 transition" /></div>
                                <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">√âtablissement</label><input type="text" value={etablissement} onChange={(e) => setEtablissement(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fr-dark-bg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-fr-blue dark:focus:ring-indigo-500 transition" /></div>
                                <button type="submit" disabled={loading} className="px-6 py-3 rounded-lg bg-fr-blue dark:bg-indigo-600 text-white font-semibold hover:bg-fr-blue/90 dark:hover:bg-indigo-500 transition disabled:opacity-50">{loading ? 'Enregistrement...' : 'Enregistrer'}</button>
                            </form>
                            <form onSubmit={handleChangePassword} className="space-y-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                                <h3 className="text-lg font-semibold text-gray-900 dark:text-white">Mot de passe</h3>
                                <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nouveau mot de passe</label><input type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-fr-dark-bg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-fr-blue dark:focus:ring-indigo-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
                                <button type="submit" disabled={loading || !newPassword} className="px-6 py-3 rounded-lg bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white font-semibold hover:bg-gray-200 dark:hover:bg-white/20 transition disabled:opacity-50">Changer</button>
                            </form>
                            {message.text && <div className={`mt-4 p-3 rounded-lg ${message.type === 'success' ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-fr-red/10 text-fr-red'}`}>{message.text}</div>}
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // ADMIN PAGE
        // ============================================
        const AdminPage = ({ onBack }) => {
            const [stats, setStats] = React.useState({ users: 0, conversations: 0, messages: 0 });
            const [users, setUsers] = React.useState([]);
            const [recentMessages, setRecentMessages] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            
            React.useEffect(() => { loadStats(); }, []);
            
            const loadStats = async () => {
                try {
                    const { data: profiles } = await supabase.from('profiles').select('*');
                    const { data: convs } = await supabase.from('conversations').select('*');
                    const { data: msgs } = await supabase.from('messages').select('*').order('created_at', { ascending: false }).limit(50);
                    setUsers(profiles || []);
                    setRecentMessages(msgs || []);
                    setStats({ users: profiles?.length || 0, conversations: convs?.length || 0, messages: msgs?.length || 0 });
                } catch (err) { console.error(err); }
                finally { setLoading(false); }
            };
            
            const formatDate = (d) => new Date(d).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            if (loading) return <div className="min-h-screen bg-fr-light dark:bg-fr-dark-bg flex items-center justify-center"><div className="text-gray-500 dark:text-gray-400">Chargement...</div></div>;
            
            return (
                <div className="min-h-screen bg-fr-light dark:bg-fr-dark-bg p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        <button onClick={onBack} className="flex items-center gap-2 text-gray-500 dark:text-gray-400 hover:text-fr-blue dark:hover:text-white mb-6 transition"><Icons.ArrowLeft /> Retour</button>
                        <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-8">üìä Administration</h1>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div className="bg-white dark:bg-fr-dark border border-gray-200 dark:border-gray-700 rounded-lg p-6"><div className="flex items-center gap-4"><div className="w-12 h-12 rounded-lg bg-fr-blue/10 dark:bg-indigo-500/20 flex items-center justify-center text-fr-blue dark:text-indigo-400"><Icons.Users /></div><div><p className="text-gray-500 dark:text-gray-400 text-sm">Utilisateurs</p><p className="text-2xl font-bold text-gray-900 dark:text-white">{stats.users}</p></div></div></div>
                            <div className="bg-white dark:bg-fr-dark border border-gray-200 dark:border-gray-700 rounded-lg p-6"><div className="flex items-center gap-4"><div className="w-12 h-12 rounded-lg bg-purple-100 dark:bg-purple-500/20 flex items-center justify-center text-purple-600 dark:text-purple-400"><Icons.Chat /></div><div><p className="text-gray-500 dark:text-gray-400 text-sm">Conversations</p><p className="text-2xl font-bold text-gray-900 dark:text-white">{stats.conversations}</p></div></div></div>
                            <div className="bg-white dark:bg-fr-dark border border-gray-200 dark:border-gray-700 rounded-lg p-6"><div className="flex items-center gap-4"><div className="w-12 h-12 rounded-lg bg-green-100 dark:bg-green-500/20 flex items-center justify-center text-green-600 dark:text-green-400"><Icons.Chat /></div><div><p className="text-gray-500 dark:text-gray-400 text-sm">Messages</p><p className="text-2xl font-bold text-gray-900 dark:text-white">{stats.messages}</p></div></div></div>
                        </div>
                        
                        <div className="bg-white dark:bg-fr-dark border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-8">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-4">üë• Utilisateurs</h2>
                            <div className="overflow-x-auto">
                                <table className="w-full"><thead><tr className="text-left text-gray-500 dark:text-gray-400 text-sm border-b border-gray-200 dark:border-gray-700"><th className="pb-3">Email</th><th className="pb-3">Nom</th><th className="pb-3">√âtablissement</th><th className="pb-3">Inscrit le</th></tr></thead>
                                <tbody>{users.map((u) => <tr key={u.id} className="border-b border-gray-100 dark:border-gray-700/50 text-gray-700 dark:text-gray-300"><td className="py-3">{u.email}</td><td className="py-3">{u.nom || '-'}</td><td className="py-3">{u.etablissement || '-'}</td><td className="py-3">{formatDate(u.created_at)}</td></tr>)}</tbody></table>
                            </div>
                        </div>
                        
                        <div className="bg-white dark:bg-fr-dark border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-4">üí¨ Messages r√©cents</h2>
                            <div className="space-y-3 max-h-96 overflow-y-auto">
                                {recentMessages.map((msg) => (
                                    <div key={msg.id} className={`p-3 rounded-lg ${msg.role === 'user' ? 'bg-fr-blue/5 dark:bg-indigo-500/10' : 'bg-purple-50 dark:bg-purple-500/10'}`}>
                                        <div className="flex items-center gap-2 mb-1"><span className={`text-xs font-medium ${msg.role === 'user' ? 'text-fr-blue dark:text-indigo-400' : 'text-purple-600 dark:text-purple-400'}`}>{msg.role === 'user' ? 'üë§ User' : 'ü§ñ Bot'}</span><span className="text-gray-400 dark:text-gray-500 text-xs">{formatDate(msg.created_at)}</span></div>
                                        <p className="text-gray-700 dark:text-gray-300 text-sm line-clamp-2">{msg.content}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // MESSAGE COMPONENT
        // ============================================
        const Message = ({ message, isUser }) => {
            const [copied, setCopied] = React.useState(false);
            const copyToClipboard = () => { navigator.clipboard.writeText(message.content); setCopied(true); setTimeout(() => setCopied(false), 2000); };
            
            return (
                <div className={`flex items-start gap-3 p-4 message-enter ${isUser ? 'flex-row-reverse' : ''}`}>
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 text-white ${isUser ? 'bg-fr-red' : 'bg-fr-blue dark:bg-indigo-600'}`}>{isUser ? <Icons.User /> : <Icons.Bot />}</div>
                    <div className={`max-w-[80%] group`}>
                        {message.file && message.fileType?.startsWith('image/') && <div className="mb-2"><img src={message.file} alt="Upload" className="max-w-[200px] max-h-[150px] object-cover rounded-lg border border-gray-200 dark:border-gray-700" /></div>}
                        {message.file && message.fileType === 'application/pdf' && <div className="mb-2 flex items-center gap-2 p-2 bg-gray-100 dark:bg-white/5 rounded-lg text-gray-600 dark:text-gray-300"><Icons.File /><span className="text-sm">{message.fileName || 'PDF'}</span></div>}
                        <div className={`rounded-2xl px-4 py-3 ${isUser ? 'bg-fr-red/10 dark:bg-red-500/20 border border-fr-red/20 rounded-tr-none' : 'bg-gray-100 dark:bg-white/10 border border-gray-200 dark:border-white/10 rounded-tl-none'}`}><p className="text-gray-800 dark:text-gray-100 whitespace-pre-wrap">{message.content}</p></div>
                        {!isUser && <button onClick={copyToClipboard} className="mt-1 px-2 py-1 text-xs text-gray-400 dark:text-gray-500 hover:text-fr-blue dark:hover:text-white transition opacity-0 group-hover:opacity-100 flex items-center gap-1"><Icons.Copy />{copied ? 'Copi√© !' : 'Copier'}</button>}
                    </div>
                </div>
            );
        };
        
        // ============================================
        // CHAT INTERFACE
        // ============================================
        const ChatInterface = ({ user, conversation, messages, setMessages }) => {
            const [input, setInput] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [file, setFile] = React.useState(null);
            const [filePreview, setFilePreview] = React.useState(null);
            const [dragOver, setDragOver] = React.useState(false);
            const messagesEndRef = React.useRef(null);
            const fileInputRef = React.useRef(null);
            
            React.useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, loading]);
            
            const handleFileSelect = (f) => {
                if (!f) return;
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
                if (!validTypes.includes(f.type)) { alert('Type non support√©'); return; }
                if (f.size > 10 * 1024 * 1024) { alert('Fichier trop volumineux (max 10 Mo)'); return; }
                setFile(f);
                if (f.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => setFilePreview(e.target.result); reader.readAsDataURL(f); }
                else setFilePreview(null);
            };
            
            const clearFile = () => { setFile(null); setFilePreview(null); if (fileInputRef.current) fileInputRef.current.value = ''; };
            
            const sendMessage = async () => {
                if ((!input.trim() && !file) || loading) return;
                const userMessage = input.trim();
                setInput('');
                
                let fileBase64 = null;
                if (file) { fileBase64 = await new Promise((resolve) => { const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.readAsDataURL(file); }); }
                
                const newUserMessage = { id: Date.now(), role: 'user', content: userMessage || `[Fichier: ${file?.name}]`, file: fileBase64, fileType: file?.type, fileName: file?.name, created_at: new Date().toISOString() };
                setMessages(prev => [...prev, newUserMessage]);
                clearFile();
                setLoading(true);
                
                try {
                    if (conversation?.id) await supabase.from('messages').insert({ conversation_id: conversation.id, role: 'user', content: newUserMessage.content });
                    
                    const payload = { question: userMessage, sessionId: conversation?.id || user.id };
                    if (fileBase64) { payload.file = fileBase64.split(',')[1]; payload.fileName = file.name; payload.fileType = file.type; }
                    
                    const response = await fetch(RAG_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const data = await response.json();
                    
                    let answer = typeof data === 'string' ? data : data.output || data.answer || data.text || (Array.isArray(data) ? data[0]?.output : JSON.stringify(data));
                    const botMessage = { id: Date.now() + 1, role: 'assistant', content: answer, created_at: new Date().toISOString() };
                    setMessages(prev => [...prev, botMessage]);
                    
                    if (conversation?.id) {
                        await supabase.from('messages').insert({ conversation_id: conversation.id, role: 'assistant', content: answer });
                        if (messages.length === 0) await supabase.from('conversations').update({ titre: userMessage.substring(0, 50), updated_at: new Date().toISOString() }).eq('id', conversation.id);
                    }
                } catch (err) {
                    setMessages(prev => [...prev, { id: Date.now() + 1, role: 'assistant', content: "‚ùå Erreur de connexion au serveur. V√©rifie que n8n tourne sur localhost:5679", created_at: new Date().toISOString() }]);
                } finally { setLoading(false); }
            };
            
            return (
                <div className="flex flex-col h-full">
                    <div className="flex-1 overflow-y-auto bg-white dark:bg-fr-dark-bg">
                        {messages.length === 0 ? (
                            <div className="h-full flex items-center justify-center p-8">
                                <div className="text-center max-w-md">
                                    <div className="w-20 h-20 rounded-2xl bg-fr-blue dark:bg-indigo-600 flex items-center justify-center mx-auto mb-6"><span className="text-4xl">üéì</span></div>
                                    <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-3">Comment puis-je t'aider ?</h2>
                                    <p className="text-gray-500 dark:text-gray-400 mb-8">Pose une question ou envoie une capture d'√©cran !</p>
                                    <div className="grid gap-3">
                                        {["Comment configurer Thunderbird ?", "Comment r√©initialiser mon mot de passe ?", "Comment acc√©der √† ARENA ?"].map((s, i) => (
                                            <button key={i} onClick={() => setInput(s)} className="px-4 py-3 rounded-lg bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10 hover:border-fr-blue dark:hover:border-indigo-500 transition text-left text-sm">{s}</button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="py-4">{messages.map((msg) => <Message key={msg.id} message={msg} isUser={msg.role === 'user'} />)}{loading && <TypingIndicator />}<div ref={messagesEndRef} /></div>
                        )}
                    </div>
                    
                    {file && (
                        <div className="px-4 py-2 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-fr-dark">
                            <div className="flex items-center gap-3 p-2 bg-white dark:bg-white/5 rounded-lg border border-gray-200 dark:border-white/10">
                                {filePreview ? <img src={filePreview} alt="Preview" className="w-16 h-16 object-cover rounded-lg" /> : <div className="w-16 h-16 bg-gray-100 dark:bg-white/10 rounded-lg flex items-center justify-center text-gray-400"><Icons.File /></div>}
                                <div className="flex-1 min-w-0"><p className="text-gray-700 dark:text-gray-300 text-sm truncate">{file.name}</p><p className="text-gray-400 text-xs">{(file.size / 1024).toFixed(1)} Ko</p></div>
                                <button onClick={clearFile} className="p-2 text-gray-400 hover:text-fr-red transition"><Icons.X /></button>
                            </div>
                        </div>
                    )}
                    
                    <div className="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-fr-dark" onDragOver={(e) => { e.preventDefault(); setDragOver(true); }} onDragLeave={() => setDragOver(false)} onDrop={(e) => { e.preventDefault(); setDragOver(false); handleFileSelect(e.dataTransfer.files[0]); }}>
                        <div className={`flex gap-3 items-end rounded-xl ${dragOver ? 'ring-2 ring-fr-blue dark:ring-indigo-500 p-2 bg-fr-blue/5 dark:bg-indigo-500/10' : ''}`}>
                            <input type="file" ref={fileInputRef} onChange={(e) => handleFileSelect(e.target.files[0])} accept="image/*,.pdf" className="hidden" />
                            <button onClick={() => fileInputRef.current?.click()} className="p-3 rounded-lg bg-gray-100 dark:bg-white/10 text-gray-500 dark:text-gray-400 hover:text-fr-blue dark:hover:text-white hover:bg-gray-200 dark:hover:bg-white/20 transition"><Icons.Upload /></button>
                            <textarea value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }} placeholder="Pose ta question..." rows={1} className="flex-1 px-4 py-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-fr-blue dark:focus:ring-indigo-500 transition resize-none" style={{ minHeight: '48px', maxHeight: '150px' }} />
                            <button onClick={sendMessage} disabled={(!input.trim() && !file) || loading} className="p-3 rounded-xl bg-fr-blue dark:bg-indigo-600 text-white hover:bg-fr-blue/90 dark:hover:bg-indigo-500 transition disabled:opacity-50"><Icons.Send /></button>
                        </div>
                        <p className="text-gray-400 dark:text-gray-500 text-xs mt-2 text-center">Entr√©e pour envoyer ‚Ä¢ Glisse-d√©pose une image/PDF</p>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // SIDEBAR
        // ============================================
        const Sidebar = ({ user, profile, isAdmin, conversations, currentConversation, onSelectConversation, onNewConversation, onDeleteConversation, onLogout, onOpenProfile, onOpenAdmin, isOpen, onClose }) => (
            <>
                {isOpen && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden" onClick={onClose} />}
                <aside className={`fixed lg:relative inset-y-0 left-0 z-50 w-72 bg-white dark:bg-fr-dark border-r border-gray-200 dark:border-gray-700 flex flex-col transform transition-transform duration-300 ${isOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                    <div className="p-4 border-b border-gray-200 dark:border-gray-700">
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-lg bg-fr-blue dark:bg-indigo-600 flex items-center justify-center"><span className="text-xl">üéì</span></div>
                                <div><h1 className="font-bold text-gray-900 dark:text-white">Assistant ADN</h1><p className="text-xs text-gray-500 dark:text-gray-400">Acad√©mie de Cr√©teil</p></div>
                            </div>
                            <button onClick={onClose} className="lg:hidden p-2 text-gray-400 hover:text-gray-600 dark:hover:text-white"><Icons.X /></button>
                        </div>
                        <button onClick={onNewConversation} className="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-fr-blue dark:bg-indigo-600 text-white font-medium hover:bg-fr-blue/90 dark:hover:bg-indigo-500 transition"><Icons.Plus />Nouvelle conversation</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-3">
                        <p className="text-gray-400 dark:text-gray-500 text-xs font-medium uppercase tracking-wider px-3 mb-2">Conversations</p>
                        <div className="space-y-1">
                            {conversations.map((conv) => (
                                <div key={conv.id} className={`group flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition sidebar-item ${currentConversation?.id === conv.id ? 'bg-fr-blue/10 dark:bg-indigo-500/20 text-fr-blue dark:text-white' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 hover:text-gray-900 dark:hover:text-white'}`} onClick={() => onSelectConversation(conv)}>
                                    <Icons.Chat /><span className="flex-1 truncate text-sm">{conv.titre || 'Nouvelle conversation'}</span>
                                    <button onClick={(e) => { e.stopPropagation(); onDeleteConversation(conv.id); }} className="opacity-0 group-hover:opacity-100 p-1 hover:bg-gray-200 dark:hover:bg-white/10 rounded transition text-gray-400 hover:text-fr-red"><Icons.Trash /></button>
                                </div>
                            ))}
                            {conversations.length === 0 && <p className="text-gray-400 dark:text-gray-500 text-sm text-center py-8">Aucune conversation</p>}
                        </div>
                    </div>
                    <div className="p-4 border-t border-gray-200 dark:border-gray-700">
                        <div className="flex items-center justify-between mb-3">
                            <ThemeToggle />
                            {isAdmin && <button onClick={onOpenAdmin} className="p-2 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/10 hover:text-fr-blue dark:hover:text-white transition" title="Administration"><Icons.Chart /></button>}
                        </div>
                        <div className="flex items-center gap-3 mb-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/5 rounded-lg p-2 transition" onClick={onOpenProfile}>
                            <div className="w-10 h-10 rounded-full bg-fr-red flex items-center justify-center text-white font-bold">{(profile?.nom || user?.email)?.[0]?.toUpperCase()}</div>
                            <div className="flex-1 min-w-0"><p className="text-gray-900 dark:text-white font-medium truncate">{profile?.nom || user?.email?.split('@')[0]}</p><p className="text-gray-500 dark:text-gray-400 text-xs truncate">{user?.email}</p></div>
                            <span className="text-gray-400"><Icons.Settings /></span>
                        </div>
                        <button onClick={onLogout} className="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-gray-100 dark:bg-white/5 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-white/10 hover:text-gray-900 dark:hover:text-white transition text-sm"><Icons.Logout />D√©connexion</button>
                    </div>
                </aside>
            </>
        );
        
        // ============================================
        // DASHBOARD
        // ============================================
        const Dashboard = ({ user, onLogout }) => {
            const [conversations, setConversations] = React.useState([]);
            const [currentConversation, setCurrentConversation] = React.useState(null);
            const [messages, setMessages] = React.useState([]);
            const [sidebarOpen, setSidebarOpen] = React.useState(false);
            const [profile, setProfile] = React.useState(null);
            const [currentPage, setCurrentPage] = React.useState('chat');
            const isAdmin = ADMIN_EMAILS.includes(user?.email);
            
            React.useEffect(() => {
                supabase.from('profiles').select('*').eq('id', user.id).single().then(({ data }) => setProfile(data));
                supabase.from('conversations').select('*').order('updated_at', { ascending: false }).then(({ data }) => setConversations(data || []));
            }, []);
            
            const loadMessages = async (convId) => { const { data } = await supabase.from('messages').select('*').eq('conversation_id', convId).order('created_at'); setMessages(data || []); };
            const createConversation = async () => { const { data } = await supabase.from('conversations').insert({ user_id: user.id, titre: 'Nouvelle conversation' }).select().single(); if (data) { setConversations(prev => [data, ...prev]); setCurrentConversation(data); setMessages([]); setSidebarOpen(false); setCurrentPage('chat'); } };
            const deleteConversation = async (id) => { await supabase.from('conversations').delete().eq('id', id); setConversations(prev => prev.filter(c => c.id !== id)); if (currentConversation?.id === id) { setCurrentConversation(null); setMessages([]); } };
            const selectConversation = async (conv) => { setCurrentConversation(conv); await loadMessages(conv.id); setSidebarOpen(false); setCurrentPage('chat'); };
            
            if (currentPage === 'profile') return <ProfilePage user={user} profile={profile} onBack={() => setCurrentPage('chat')} onUpdateProfile={(u) => setProfile(prev => ({ ...prev, ...u }))} />;
            if (currentPage === 'admin' && isAdmin) return <AdminPage onBack={() => setCurrentPage('chat')} />;
            
            return (
                <div className="h-screen bg-fr-light dark:bg-fr-dark-bg flex">
                    <Sidebar user={user} profile={profile} isAdmin={isAdmin} conversations={conversations} currentConversation={currentConversation} onSelectConversation={selectConversation} onNewConversation={createConversation} onDeleteConversation={deleteConversation} onLogout={onLogout} onOpenProfile={() => setCurrentPage('profile')} onOpenAdmin={() => setCurrentPage('admin')} isOpen={sidebarOpen} onClose={() => setSidebarOpen(false)} />
                    <main className="flex-1 flex flex-col min-w-0">
                        <header className="lg:hidden flex items-center gap-4 p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-fr-dark">
                            <button onClick={() => setSidebarOpen(true)} className="p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"><Icons.Menu /></button>
                            <h1 className="font-bold text-gray-900 dark:text-white">{currentConversation?.titre || 'Assistant ADN'}</h1>
                        </header>
                        {currentConversation ? <ChatInterface user={user} conversation={currentConversation} messages={messages} setMessages={setMessages} /> : (
                            <div className="flex-1 flex items-center justify-center p-8 bg-white dark:bg-fr-dark-bg">
                                <div className="text-center">
                                    <div className="w-24 h-24 rounded-2xl bg-fr-blue dark:bg-indigo-600 flex items-center justify-center mx-auto mb-6"><span className="text-5xl">üéì</span></div>
                                    <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-3">Bienvenue !</h2>
                                    <p className="text-gray-500 dark:text-gray-400 mb-8 max-w-md">Je suis l√† pour t'aider avec les proc√©dures informatiques de l'Acad√©mie.</p>
                                    <button onClick={createConversation} className="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-fr-blue dark:bg-indigo-600 text-white font-semibold hover:bg-fr-blue/90 dark:hover:bg-indigo-500 transition"><Icons.Plus />Nouvelle conversation</button>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        
        // ============================================
        // APP
        // ============================================
        const App = () => {
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [page, setPage] = React.useState('login');
            
            React.useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => { setUser(session?.user ?? null); setLoading(false); });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_, session) => setUser(session?.user ?? null));
                return () => subscription.unsubscribe();
            }, []);
            
            if (loading) return <div className="min-h-screen bg-white dark:bg-fr-dark-bg flex items-center justify-center"><div className="text-center"><div className="w-16 h-16 rounded-xl bg-fr-blue dark:bg-indigo-600 flex items-center justify-center mx-auto mb-4"><span className="text-3xl">üéì</span></div><p className="text-gray-500 dark:text-gray-400">Chargement...</p></div></div>;
            if (user) return <Dashboard user={user} onLogout={async () => { await supabase.auth.signOut(); setUser(null); }} />;
            if (page === 'register') return <RegisterPage onSwitchToLogin={() => setPage('login')} />;
            return <LoginPage onLogin={setUser} onSwitchToRegister={() => setPage('register')} />;
        };
        
        // Render with Theme Provider
        ReactDOM.createRoot(document.getElementById('root')).render(
            <ThemeProvider>
                <App />
            </ThemeProvider>
        );
    </script>
</body>
</html>
